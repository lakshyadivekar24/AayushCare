{% extends 'records/base.html' %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
    <div class="dashboard-header mb-4">
        <h2><i class="fas fa-search me-2"></i>Search Patient Records</h2>
        <p class="text-muted">Enter a patient's Aadhar number to view their history, or see your recent activity below.</p>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="post" action="{% url 'search_patient' %}">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" name="aadhar_number" class="form-control form-control-lg" placeholder="Enter Patient's 12-digit Aadhar Number" value="{{ search_query|default:'' }}" required>
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search me-1"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        {% if patient_found %}
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h3>Search Result for: {{ patient.name }}</h3>
                <a href="{% url 'add_record_for_patient' patient.id %}" class="btn btn-light btn-sm">
                    <i class="fas fa-plus me-1"></i> Add New Record
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead><tr><th>Date</th><th>Doctor</th><th>Symptoms</th><th>Diagnosis</th><th>Prescription</th><th>Dose</th><th>Report</th></tr></thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td><strong>{{ record.record_date }}</strong></td>
                                <td>Dr. {{ record.doctor.name }}</td>
                                <td>{{ record.symptoms|default:"N/A" }}</td>
                                <td>{{ record.diagnosis|default:"N/A" }}</td>
                                <td>{{ record.prescription|default:"N/A" }}</td>
                                <td>{{ record.dose|default:"N/A" }}</td>
                                <td>{% if record.report_file %}<a href="{{ record.report_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>{% else %}<span class="text-muted">No File</span>{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center">This patient has no medical records yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif error %}
            <div class="alert alert-danger mb-0" role="alert">
                {{ error }}
            </div>

        {% else %}
            <div class="card-header">
                <h3>Your Recent Patient History</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead><tr><th>Patient Name</th><th>Date</th><th>Diagnosis</th><th>Prescription</th><th>Report</th></tr></thead>
                        <tbody>
                            {% for record in records_by_doctor %}
                            <tr>
                                <td><strong>{{ record.patient.name }}</strong></td>
                                <td>{{ record.record_date }}</td>
                                <td>{{ record.diagnosis|default:"N/A" }}</td>
                                <td>{{ record.prescription|default:"N/A" }}</td>
                                <td>{% if record.report_file %}<a href="{{ record.report_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>{% else %}<span class="text-muted">No File</span>{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center">You have not attended to any patients yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}